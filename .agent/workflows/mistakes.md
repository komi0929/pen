---
description: 繰り返しミスの再発防止チェックリスト（コマンド実行前・コード変更前に必ず確認）
---

# ⛔ 再発防止ルール

**このファイルはすべての作業開始時に暗黙的に適用される。**

> [!CAUTION]
> **コマンド実行前・コード編集前に必ずこのファイルを確認すること。**
> 読んでいない状態で作業した場合、それ自体がルール違反。
>
> **違反履歴:**
>
> - 2026-02-20: PowerShell `&&` を3回連続使用、`tail` コマンド使用、`import` 追加漏れ
> - 原因: 作業前にこのファイルを確認しなかった

---

## 1. PowerShell コマンド（Windows環境）

| ❌ やりがち          | ✅ 正しい                                        |
| -------------------- | ------------------------------------------------ |
| `cmd1 && cmd2`       | `cmd1; cmd2`                                     |
| `cmd \| tail -60`    | `cmd \| Select-Object -Last 60`                  |
| `cmd \| head -20`    | `cmd \| Select-Object -First 20`                 |
| `cmd \| grep "text"` | `cmd \| Select-String "text"`                    |
| `cd some/path`       | `run_command` の `Cwd` パラメータで指定          |
| `cat file.txt`       | `Get-Content file.txt` または `view_file` ツール |

- **`&&` は絶対に使わない** → PowerShell では構文エラー。`;` を使う
- **`cd` コマンドは使わない** → `run_command` の `Cwd` パラメータで指定
- **Linux 専用コマンドを使わない** → `tail`, `head`, `grep`, `cat`, `wc` 等は PowerShell 代替を使う

## 2. import 追加漏れ（⚠️ 頻発）

**新しいコンポーネント・関数を使う場合、import が正しく保存されたかビルド前に必ず確認する。**

| 頻発パターン                            | 原因                                                        |
| --------------------------------------- | ----------------------------------------------------------- |
| `Settings` が見つからない（Header.tsx） | import に `Settings` を追加したつもりが保存されていなかった |
| `StyleReference` 型が未定義             | import に型を追加し忘れ                                     |
| 新しいアイコンが未定義                  | lucide-react の import に追加し忘れ                         |

- **`multi_replace_file_content` で import 行を変更した後、ビルド前に `view_file` で import 部分を必ず再確認する**
- 特に既存の import 行に新しい名前を追加する変更は失敗しやすい

## 3. `replace_file_content` / `multi_replace_file_content` のターゲット不一致（⚠️ 頻発）

**TargetContent が実際のファイル内容と一致しないことが頻発している。**

| 頻発パターン             | 原因                                                             |
| ------------------------ | ---------------------------------------------------------------- |
| chunk が適用されない     | TargetContent の改行コード、空白、インデントが実ファイルと不一致 |
| 複数の同じテキストがある | AllowMultiple を設定し忘れ or ユニークな範囲を指定しなかった     |
| 古い内容を参照している   | ファイルを事前に `view_file` で確認していない                    |

- **編集前に必ず対象範囲を `view_file` で確認する**
- **chunk 適用失敗のエラーが出たら、直後に `view_file` で該当行を再確認してからリトライする**
- **1つの `multi_replace_file_content` で多数のchunkを一度に変更しようとしすぎない**

## 4. ビルド前確認の省略

- **`npm run build` を実行する前に、変更した全ファイルの import 文が正しいか確認する**
- ビルドエラーが出た場合は修正してからコミットする（GEMINI.mdルール）
- ビルドエラーの修正後、2回目のビルドを必ず通してからコミット

## 5. コミット前の確認

- [ ] `git add` と `git commit` と `git push` は **個別のコマンドか `;` で連結**（`&&` 禁止）
- [ ] コミットメッセージは `feat:` / `fix:` / `style:` / `refactor:` のプレフィックス付き
- [ ] 大規模変更時は改善履歴 API を叩いてからコミット

## 6. Next.js / React

- [ ] Client Component には `'use client'` を明記
- [ ] import は `@/` エイリアスを使用（`../` 相対パス禁止）
- [ ] Server Actions は `try-catch` で囲む
- [ ] 未使用の import を残さない（`Bot` を消したのに import に残す等）

## 7. Tailwind CSS v4

- [ ] `@apply` 内で使えないユーティリティがある → 直接 `className` に書く
- [ ] カスタムカラーは `@theme` で定義済みのものを使う

## 8. Supabase

- [ ] RLS ポリシーは `auth.uid()` ベース
- [ ] `SUPABASE_SERVICE_ROLE_KEY` はサーバーサイドのみ
- [ ] マイグレーション作成後は適用を確認する（CLI未リンクの場合はユーザーに明示的に伝える）
- [ ] 新テーブルの型が `database.types.ts` にない場合は `as any` キャストを使う（既存パターン準拠）

## 9. 作業スタイル（厳命）

- [ ] **曖昧な指示は仮説付きで確認** → 「〜ということですか？」と仮説を立てて確認する。勝手に解釈して進めない
- [ ] **実装前により良い方法がないか検証** → ユーザーの指示を鵜呑みにせず、代替案を検討する
- [ ] **より良い方法が見つかった場合は必ずユーザーの確認を取る** → 確認後に計画を修正する
- [ ] **⚠️ 指示と異なることをする場合の事前確認は必須（厳命）** → 勝手に方針を変えない。必ず事前に理由を説明し承認を得る
- [ ] **報告は日本語**
- [ ] ビルドエラーは自動修正してからプッシュ

---

## 📋 インシデントログ

| 日付       | ミスの内容                                    | カテゴリ         | 根本原因                           |
| ---------- | --------------------------------------------- | ---------------- | ---------------------------------- |
| 2026-02-20 | `\| tail -60` をPowerShellで使用              | PowerShell       | Linux コマンドを無意識に使用       |
| 2026-02-20 | `&&` でコマンド連結（3回連続）                | PowerShell       | mistakes.md を読まずに作業開始     |
| 2026-02-20 | `Settings` import が保存されずビルド失敗      | import漏れ       | import 変更後の確認を省略          |
| 2026-02-20 | `multi_replace_file_content` chunk 5 適用失敗 | ターゲット不一致 | TargetContent が実ファイルと不一致 |
| 2026-02-20 | Supabase CLI 未リンクでマイグレーション失敗   | Supabase         | 環境状態の事前確認なし             |
