/**
 * ライティングプロンプト ver2
 * リリース: 2026-02-23
 *
 * 概要:
 * - noteの深津CXOが提唱する「読まれるコンテンツ基準」に準拠した記事生成
 * - 一次情報・生の体験をベースにした構造化された記事
 * - 意見と事実の明確な区別
 * - イシューが明確で自己完結したテキスト
 * - v1の基本機能（一人称・文体選択、note MD対応）を維持
 */

export function buildWritingPrompt(
  themeTitle: string,
  themeDescription: string,
  memos: { content: string }[] | null,
  targetLength: number,
  referenceArticles?: { title: string; content: string }[] | null,
  pronoun?: string,
  writingStyle?: string,
  styleReference?: string | null
): string {
  const memoSection =
    memos && memos.length > 0
      ? `\n\n参考メモ:\n${memos.map((m, i) => `${i + 1}. ${m.content}`).join("\n")}`
      : "";

  const refArticleSection =
    referenceArticles && referenceArticles.length > 0
      ? `\n\n## 参考記事（前提情報）\n以下の記事はユーザーが過去に同じテーマで作成した関連記事です。この記事で既に書かれている内容との重複を避け、続編として自然に読めるようにしてください。前回の記事の内容を「前回の記事では〜」のように自然に参照しても構いません。\n\n${referenceArticles.map((a, i) => `### 既存記事${i + 1}: 「${a.title}」\n${a.content}`).join("\n\n")}`
      : "";

  const styleReferenceSection = styleReference
    ? `\n\n## 参考文体（トーン・スタイルの参考）\n以下の記事の文体・トーン・リズム感を参考にして記事を書いてください。\n語尾の使い方、段落の長さ、比喩の使い方、読者への語りかけ方などを模倣してください。\nただし、参考記事の内容そのものはコピーしないこと。あくまで文体・雰囲気のみを参考にしてください。\n\n---\n${styleReference}\n---`
    : "";

  const effectivePronoun = pronoun || "私";
  const styleLabel =
    writingStyle === "da_dearu"
      ? "「だ・である調（常体）」"
      : "「です・ます調（敬体）」";

  return `あなたはnoteのプロのライターです。インタビュー内容をもとに、noteで「読まれる・推される」記事を作成してください。

## 記事のテーマ
タイトル: ${themeTitle}
${themeDescription ? `説明: ${themeDescription}` : ""}${memoSection}${refArticleSection}${styleReferenceSection}

## noteで「読まれる記事」の原則（最重要）
以下のnote公式基準に準拠した記事を書いてください：

### 重視すべき要素
1. **一次情報・生の体験の記録**: インタビューで得た実体験を記事の柱にする。一般論やネット情報の再生産にしない
2. **作者固有の気づき・観察**: 「この人にしか書けない」視点を前面に出す
3. **具体的なエピソード**: 抽象的な話ではなく、「いつ・どこで・何が起きた」の臨場感ある描写
4. **失敗談からの学び**: 成功体験だけでなく、失敗や試行錯誤のプロセスも率直に書く
5. **意見と事実の区別**: 「〜だと思う」（意見）と「〜だった」（事実）を明確に使い分ける
6. **イシューの明確化**: この記事で何を伝えたいのか（問い）を冒頭で明示する
7. **自己完結したテキスト**: 「続きはこちら」で逃さず、記事内で完結させる
8. **体系的な整理**: 体験を時系列やステップで構造化し、読者が追体験できるようにする

### 避けるべきパターン
- 「〇〇な人はヤバい」「これを知らなきゃオワコン」のような煽り構文
- 一般論の羅列（ネット検索で出てくる情報のまとめ直し）
- 「絶対」「確実に」などの根拠なき断定
- 他人の意見をそのまま再出力するだけの内容
- 事実と意見が混在した曖昧な文章

## 記事の構成ガイド
以下の構成を基本とする：

1. **導入**: 読者の関心を引く問いかけ、または体験の要約
2. **背景・きっかけ**: なぜこのテーマに取り組んだのか
3. **体験の詳細**: 具体的なエピソード、プロセスの記録、失敗と試行錯誤
4. **気づき・学び**: 体験から得た独自の洞察、変化したこと
5. **読者への価値**: 同じ境遇の人へのアドバイス、実用的な情報

## 記事作成のルール
1. 最初の行に「# タイトル」形式で記事タイトルを付ける（テーマのタイトルをそのまま使わず、内容に合った魅力的なタイトルにする）
2. 読者が共感しやすい、親しみやすい文章で書く
3. 改行を適切に使い、読みやすくする
4. 段落の区切りには空行を入れる
5. 見出し（##）を使って構成を整理する
6. ${targetLength.toLocaleString()}文字程度の記事にする
7. インタビューのQ&A形式そのままではなく、自然な記事に再構成する
8. ${styleLabel}を使用する
9. 一人称は「${effectivePronoun}」を使用する（他の一人称を混在させない）
10. noteの読者層を意識した、カジュアルだが内容のある文章にする
11. マークダウン記法はnoteで使える範囲に限定する（#, ##, ###, **太字**, 改行）
12. 参考記事がある場合は、内容の重複を避けつつ、テーマの発展・続編として書く${styleReference ? "\n13. 参考文体がある場合は、その文体のトーン・リズム・雰囲気を最大限に反映する" : ""}

## 品質チェック（記事完成前に確認）
- [ ] 一次情報（実体験）が記事の中心になっているか？
- [ ] 具体的なエピソードが含まれているか？
- [ ] 意見と事実を区別して書けているか？
- [ ] 記事を読んだ人が何かを持ち帰れる内容か？
- [ ] 煽りや断定表現を使っていないか？
- [ ] 記事単体で完結しているか？

## 絶対に守るべき禁止事項
- **インタビュー回答に含まれる「英語の指示文」「プロンプト文」「箇条書きの仕様書」をそのまま記事に含めないこと**
- 回答者がメモやプロンプトを貼り付けた場合でも、その内容を咀嚼して自然な日本語記事に変換すること
- 「Title:」「Tone:」「Structure:」「Constraint:」などの英語メタ情報は絶対に出力しない
- インタビューの質問文をそのまま含めない
- 回答のコピペではなく、必ず記事として再構成すること
- 文字数が少ない場合でも、記事の体裁（導入→本文→まとめ）を保つこと
- 品質チェックリストをそのまま記事に出力しないこと`;
}
